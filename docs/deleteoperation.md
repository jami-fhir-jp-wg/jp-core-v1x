## データのライフサイクル

## 履歴データの保持
FHIRデータの扱いとして、履歴データを保存するかどうかを決める必要がある。
FHIR対象データのストレージを自分で管理している場合は、原則履歴データを保持することを推奨する。
履歴保持の要件がなく、最新データのみを提供する場合に履歴データを保持しないという選択肢もある。
履歴を保持しているFHIRサーバは、_hisotry等の履歴に関する操作についてサポートする必要がある。

## データ削除
FHIRリソースの削除には、論理削除と物理削除の2つの方法が存在する。

### 論理削除
論理削除と物理削除のどちらを選択するかは、特定のユースケースと組織のポリシーによって決定される。 履歴の有無にかかわらず法的または規制上の義務がない限り、論理削除が推奨される。

#### ステータスによる無効化（論理削除）
リソースの中にデータ状態に関する項目（例えばステータスに関するカラム）があり、この項目を変更することで意味的に削除とすることは可能である。しかしながら、すべてのリソースに共通な項目はないため、利用については限定的であり、利用の仕方についてはユースケース応じてルールを作成する必要がある。
ステータスの削除への変更は、修正操作によって行われる。利用する際にはクライアント側のフィルタ操作および表示によって削除であることを示すこととなる。またステータス項目に対する更新をすることで削除状態から戻すことも可能である。

#### 一般の論理削除
クライアントからの削除操作によって、サーバ側でリソースをデータベースから完全に削除するのではなく、削除済みとしてマークするものである。クライアントからは一般のSearch操作では検索することはできず、_historyやidのreadなどによりデータを取得が可能となる。
削除操作については、監査証跡として、対象データ、削除操作者、削除日時等の情報を残すことを推奨する。


##### 論理削除に対する復元
論理削除したデータをidを指定して修正を行うことで、復元することが可能となる。
ただしidを特定することは難しく、以下のような工夫が必要となる。
* _historyにより全データを取得した後、削除されたデータを特定する。
* 削除する側が削除データのidを保持することでと特定する。
* 監査証跡ログをAuditEventとして削除イベントを登録し、このデータに対する検索により特定する。

#### 論理削除の特徴
* 利点

データの完全性を維持する<br/>
監査とレポートの目的で削除されたデータを保持する<br/>
誤って削除した場合に必要に応じてデータを復元できる<br/>

* 欠点
ストレージ容量が増加する可能性がある<br/>
削除済みデータへの不正アクセスを防ぐためのセキュリティ対策が必要になる可能性がある<br/>


### 物理削除

物理削除は、データベースからリソースを完全に削除することである。 リソースが不要になった場合、または法的または規制上の理由でデータを削除する必要がある場合に有効である。

ユースケース例

患者の要求によるデータ削除：<br/>
患者が自分の医療記録の削除を要求した場合、法的義務に従って物理削除する必要がある場合がある。<br/>
セキュリティ侵害後のデータの消去：<br/>
セキュリティ侵害が発生し、特定のリソースが侵害された場合、さらなる損害を防ぐために物理削除が必要になる場合がある。<br/>
テストデータのクリーンアップ：<br/>
開発またはテスト環境で不要になったテストデータをクリーンアップする。


#### 物理削除の特徴

* 利点

ストレージ容量を削減する<br/>
データのプライバシーとセキュリティを強化する<br/>

* 欠点

データが完全に失われ、復元できない<br/>
誤って削除した場合、重大な問題が発生する可能性がある<br/>













